###########
# Library #
###########

library(dplyr)
library(factoextra)
library(ggfortify)
library(ggplot2)
library(gridExtra)
library(openxlsx)
library(psych)
library(readr)
library(readxl)
library(SKAT)
library(tidyr)
library(xlsx)

############
# Datasets #
############

lung <- read_csv("C:/Users/knigh/OneDrive/Desktop/Github/TCR-Project/Datasets/Lung Data/dt.analysis.lung.csv",
                 show_col_types = FALSE)
lungenes <- read_csv("C:/Users/knigh/OneDrive/Desktop/Github/TCR-Project/Datasets/Lung Data/vjGene.p.all.bytime.csv",
                     show_col_types = FALSE)

#############
# Summaries #
#############

lung <- lung %>% 
  mutate_at(c('Patient.Status', 'Phase', 'Disease.Type', 'TRTP', 'DISTYP', 
              'PDL1_TC', 'PDL1STAT', 'AGEU', 'AGEGR1', 'SEX', 'RACE', 
              'RACEGR1', 'SMOKHIST', 'SMOKGR1', 'COUNTRY', 'REGION1', 
              'LINTXGR1', 'PRPLAT', 'PLATMTYP', 'Status', 'LIVERBL',
              'Response', 'Response.bin1', 'Response.bin2'), as.factor)
cat("Summary of lung as factors: \n\n")
summary(lung)

lungenes <- lungenes %>% 
  mutate_at(c('...1'), as.factor)
cat("Summary of lungenes as factors: \n\n")
summary(lungenes)

#############
# Dimscribe #
#############

describe(lung)
dim(lung)
describe(lungenes)
dim(lungenes)

################
# Dataset Prep #
################

# no need for screening
lungene <- lungenes[, -c(2:70)]

# pre-infusion
pre <-  lungene[, c(1:62)]

# for NAs and 0s
pre[is.na(pre)] <- 1e-7
pre[pre==0] <- 1e-7

colnames(pre) <- c("vjGene", "1056201652", "1056201734", "1056201763",
                   "1056201766", "1093501642", "1093501649",  "1093501690",
                   "1245501789", "1322701679", "1351901585",  "1351901590",
                   "1351901743", "1351901799", "1371101668", "1371101712",
                   "2000044446", "2000044709", "2000044739", "2000044755",
                   "2000044784", "2000134826", "2000167902", "2000199725", 
                   "2000206742", "2000206980", "2000210806", "2000210942",
                   "2000211830", "10562011366", "10562011565", "12455011536",
                   "13227011150", "13519011353", "13711011381", "20000891275",
                   "20001081074", "20001331759", "20001351017", "20001351914",
                   "20001352321", "20001371882", "20001971574", "20001971832",
                   "20001991312", "20002061151", "20002061360", "20002062054",
                   "20002081893", "20002091885", "20002101827", "20002111889",
                   "20002131864", "20002181234", "20002181334", "20004391109",
                   "20004391114", "20007341206", "20007341222", "20007341336", 
                   "20007341420", "20011092291")

preLong <- pivot_longer(pre, 
                         cols = c("1056201652", "1056201734", "1056201763",
                                  "1056201766", "1093501642", "1093501649",  
                                  "1093501690", "1245501789", "1322701679", 
                                  "1351901585",  "1351901590", "1351901743", 
                                  "1351901799", "1371101668", "1371101712",
                                  "2000044446", "2000044709", "2000044739", 
                                  "2000044755", "2000044784", "2000134826", 
                                  "2000167902", "2000199725", "2000206742", 
                                  "2000206980", "2000210806", "2000210942",
                                  "2000211830", "10562011366", "10562011565", 
                                  "12455011536", "13227011150", "13519011353", 
                                  "13711011381", "20000891275", "20001081074", 
                                  "20001331759", "20001351017", "20001351914",
                                  "20001352321", "20001371882", "20001971574", 
                                  "20001971832", "20001991312", "20002061151", 
                                  "20002061360", "20002062054", "20002081893", 
                                  "20002091885", "20002101827", "20002111889",
                                  "20002131864", "20002181234", "20002181334", 
                                  "20004391109", "20004391114", "20007341206", 
                                  "20007341222", "20007341336", "20007341420", 
                                  "20011092291"),
                         names_to = "Patient.ID", values_to = "Value")

# log transform 
preLong$Value <- log(preLong$Value)
# standardize
preLong$Value <- scale(preLong$Value)

preWide <- pivot_wider(preLong, names_from = "vjGene", values_from = "Value")











# 2nd dose
second <- lungene[, c(1, 63:123)]

second[is.na(second)] <- 1e-7 

colnames(second) <- c("vjGene", "1056201630", "1056201652", "1056201723", 
                      "1056201734", "1056201763", "1056201766", "1093501642",
                      "1093501649", "1093501690", "1322701679", "1351901585",
                      "1351901590", "1351901743", "1351901799", "1371101668",
                      "1371101712", "2000044446", "2000044739", "2000044755",
                      "2000044784", "2000134826", "2000199725", "2000206731",
                      "2000206742", "2000206980", "2000210806", "2000210942",
                      "2000211830", "10025011361", "10562011366", "10562011565",
                      "12455011536", "13227011150", "13519011344", 
                      "13519011345", "13519011353", "13711011381", 
                      "20000891275", "20001081074", "20001331759", 
                      "20001351017", "20001352321", "20001971574", 
                      "20001991312", "20002061360", "20002062054", 
                      "20002081760", "20002081893", "20002091874", 
                      "20002091885", "20002101827", "2000211132", "20002132350",
                      "20002181234", "20004391109", "20004391114", 
                      "20007341206", "20007341222", "20007341336", 
                      "20007341420", "20011092291")

